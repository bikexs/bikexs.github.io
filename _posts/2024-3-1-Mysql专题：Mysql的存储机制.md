title: Mysql专题: Mysql的存储机制
author: bikexs
date: 2024-3-1 7:00:00 +0800
categories: [Java]
tags: [Mysql]
math: true
mermaid: true

### 一、问题背景

1.1、一句话描述

了解mysql的Innodb存储引擎，都包括哪些部分。

### 二、 基本概念

#### 2.1 InnoDB 与 MySQL 的关系

InnoDB 是 MySQL 的存储引擎之一，支持事务（ACID属性），行级锁定，以及外键约束。作为 MySQL 的默认存储引擎，主要用于需要高可靠性和高并发访问的应用场景，目前大多数情况下都是用的这个。

#### 2.2 表和表空间

在 InnoDB 中，表和索引都存储在一个共享表空间（shared tablespace）或独立表空间（file-per-table tablespace）中。默认情况下，MySQL 8.0 使用独立表空间，每个表都有自己的 .ibd 文件。

### 三、 数据文件结构

#### 3.1 表空间（Tablespace）

表空间是存储 InnoDB 数据和索引的逻辑容器，可以包含一个或多个数据文件。InnoDB 表空间分为系统表空间和独立表空间：

- **系统表空间**：存储数据字典、双写缓冲区等全局信息。
- **独立表空间**：每个 InnoDB 表单独存储在一个 .ibd 文件中。

#### 3.2 页（Page）和区（Extent）

InnoDB 将数据存储在页（Page）中，每页默认大小为 16KB。多个页组成一个区（Extent），一个区包含 64 个页，共计 1MB。InnoDB 使用页作为基本的 I/O 单位进行读写操作。

### 四、索引机制

#### 4.1 聚簇索引（Clustered Index）

InnoDB 使用聚簇索引（Clustered Index）来存储表数据。每个 InnoDB 表都有一个聚簇索引，表数据按照主键顺序存储。聚簇索引将数据和索引保存在同一 B+ 树中，因此在查找数据时非常高效。

聚集索引不同地方叫法有点不同，有叫做主键索引也有叫做聚簇索引的，原理上都是Innodb引擎针对于主键索引创建的索引树，也就是说是无法手动在建表之后去创建聚集索引的，如果需要更改聚集索引，那么就只能重新创建表，将原本的数据写入到新的表中。

#### 4.2 辅助索引（Secondary Index）

辅助索引（Secondary Index）用于加速非主键列的查询。与聚簇索引不同，辅助索引的叶子节点存储的是主键值而不是行数据。在通过辅助索引查找数据时，需要先查找主键值，再通过主键值查找聚簇索引中的行数据。

辅助索引也叫做非聚集索引，包括唯一key，外键索引等。

索引的详细分析看另一篇索引专题的总结。

### 五、 锁机制

#### 5.1 行级锁（Row-Level Locking）

InnoDB 支持行级锁定，包括共享锁（S Lock）和排他锁（X Lock）。共享锁允许多个事务并发读取同一行数据，而排他锁则独占行数据，防止其他事务进行读取或修改。

#### 5.2 意向锁（Intention Lock）

为了支持行级锁与表级锁的共存，InnoDB 引入了意向锁（Intention Lock）。意向锁包括意向共享锁（IS Lock）和意向排他锁（IX Lock），用于表明事务即将在表的某些行上获取共享锁或排他锁。

除了这个，还包括对索引进行查找时用到的间隙锁和临建锁。

下面是不同事务隔离级别下的加锁措施：

| 隔离级别 | 脏读 | 不可重复读 | 幻读 | 读操作加锁                     | 写操作加锁         |
| -------- | ---- | ---------- | ---- | ------------------------------ | ------------------ |
| 读未提交 | 可能 | 可能       | 可能 | 无                             | X 锁               |
| 读已提交 | 防止 | 可能       | 可能 | 无（使用 MVCC 读取已提交版本） | X 锁               |
| 可重复读 | 防止 | 防止       | 可能 | 无（使用 MVCC 读取快照版本）   | X 锁（使用间隙锁） |
| 可串行化 | 防止 | 防止       | 防止 | S 锁                           | X 锁               |
|          |      |            |      |                                |                    |

详细的锁相关的数据看另一篇专题分析。

### 六、 事务处理

#### 6.1 ACID 属性

InnoDB 支持事务的 ACID 属性：

- **原子性（Atomicity）**：事务操作要么全部成功，要么全部回滚。
- **一致性（Consistency）**：事务将数据库从一种一致状态转换为另一种一致状态。
- **隔离性（Isolation）**：事务的执行不受其他事务的干扰。
- **持久性（Durability）**：事务提交后，其对数据库的修改是永久性的。

#### 6.2 隔离级别

InnoDB 支持四种隔离级别：

- **读未提交（Read Uncommitted）**：事务可以读取未提交的数据，可能导致脏读。
- **读已提交（Read Committed）**：事务只能读取已提交的数据，防止脏读。
- **可重复读（Repeatable Read）**：同一事务中多次读取相同数据，结果一致，防止不可重复读和幻读。
- **可串行化（Serializable）**：事务完全串行化执行，防止所有并发问题。

事务的详细分析看另一篇专题分析。

### 七、其他机制（简单了解，一个IO和优化相关）

#### 7.1 双写缓冲（Doublewrite Buffer）

InnoDB 使用双写缓冲机制防止部分写入失败导致的数据损坏。在将数据页从缓冲池写入磁盘之前，先将页写入双写缓冲区。确保页在写入磁盘过程中，如果发生故障，可以从双写缓冲区恢复。

#### 7.2 自适应哈希索引（Adaptive Hash Index）

InnoDB 会自动将一些经常访问的页转换为哈希索引，提高查询速度。这种机制称为自适应哈希索引，可以加快热数据的访问速度。

