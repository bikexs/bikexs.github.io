---
title: Redis专题：Redis的数据持久化
author: bikexs
date: 2024-3-1 7:00:00 +0800
categories: [Java]
tags: [Redis]
math: true
mermaid: true
---

### 一、问题背景

1.1、一句话描述

如果redis服务宕机了，数据应该怎么处理？



1.2、解决思路引入

服务挂掉存储在内存中的数据丢失了，那想办法把这部分数据进行一个持久化存储，在redis启动的时候再把数据读取到内存中就可以了，而这个持久化的方式redis中已经提供了RDB和AOF来达到持久化存储的功能。

再进一步，有没有办法就直接让redis没这么容易就挂掉，因为本身redis在系统中就占据很重要的地位，一旦挂了对整个服务集群可能都有不小的影响。

怎么提高redis的高可用性？

简单的方式就是直接做个主从集群，常见的就是1主2从，在主服务器挂掉的时候新的从节点顶上。

在主节点挂了的时候，又怎么把从节点作为主节点给代替上呢？

再加上个专门用于监控节点状态的服务，称之为哨兵，同样为了提高哨兵的可用性，也可以进行一个集群。

随着时间的推移，每个节点中都保存着全量数据，数据量越来越多的时候很容易达到瓶颈，这该怎么办？

显然需要各个节点分别保存一部分数据，统一通过一个标志槽来区分各个节点都保存了哪些数据。同样，为了保证各个节点保存的数据的可用性，也对各个节点再做个主从集群。

### 二、redis持久化方式1：RDB



redis中的数据是存储在内存中的，那直接将这个数据给写入到磁盘中不就行了。为了避免阻塞redis提供服务，可以通过fork一个子线程去做这件事。

但是这个备份数据的时间间隔应该怎么设定呢？

对于备份数据而言，只有写操作才会产生新的数据，这个时候才需要进行备份。因此，需要一个配置条件，根据这个配置条件去判断什么时候应该进行一个备份。也就是redis中提供的备份策略配置参数。比如

```
save 900 1 #900秒内有一个写入
save 60 10000 #60秒内有10000个写入
```

但是还可能会存在个问题，备份数据的过程中产生的新数据并没有处理到，如果说对数据完整性要求不高的情况，RDB这种方式可以满足，也就是redis默认使用这种方式。

但是如果对于数据完整性要求很高，又或者每秒产生的新数据非常多而且不能丢失，这种情况下就需要采用一种存储更完整的方式，也就是AOF。

### 三、redis持久化方式2：AOF

在RDB中，数据备份数据过程中产生的新数据没有及时处理到，为了解决这个问题，redis提供了另一种文件持久化的方式AOF（Append Only File）。

这种方式下，不再是往RDB文件中写入所有的redis缓存数据，而是另外使用一个AOF文件，AOF文件中写入的不是所有redis缓存的数据，而是一条条的操作指令，类似mysql的undo日志，在每一次执行命令的时候将命令写入到这个文件中。通过这个指令日志，同样可以将互redis数据还原出来。

每次执行命令的时候都写入到文件中，会存在IO问题，可以先设定一个缓冲区，每次执行命令的时候不直接写入到文件中，而是写入到缓冲区中，然后在一定时机再把这个缓冲区的内容写入到文件中。

看起来应该是没有什么问题了，不过在写入的指令数越来越多，会导致AOF文件的大小非常大，这就需要一个重写操作，将AOF的日志进行一个压缩和重写。比如，将连续的push操作指令直接合成一条指令。但是如果通过操作指令进行分析应该怎么生成新的redis操作指令，这是比较麻烦的。

redis中重写的做法是直接根据redis当前的状态来进行redis操作指令的生成，而不是去分析执行令的过程。

同样的，在AOF缓冲区的数据写入到文件中的时候，也需要记录下这个过程中产生的新数据，redis中采用了一个aof重写缓冲区，用于记录这个新产生的数据。在aof缓冲区的数据写入到文件完成之后，fork一份文件，将新产生的指令数据添加到文件的末尾，最后再将这个新文件替换旧的AOF文件，整个过程就完成了。

### 四、redis主从数据的同步

数据持久化的问题解决了，就是redis高可用的问题了。

为一个redis节点创建两个副本作为从节点，主节点负责写数据和将数据同步到从节点，从节点则负责读数据。

那么怎么将主节点的数据同步到从节点呢？
将主节点的备份数据数据直接发送到从节点中，从节点重新加载这份数据来替换自己的缓存，这个过程中产生的新的操作指令也同步到从节点中，让从节点同步完备份数据再同步这部分数据。

上面这样实际上还会有些问题，每次都同步所有数据，这并不方便。

因此，在主节点中，用一个缓冲区存储所有的数据，从节点中各自记录着一个数据复制的偏移，用于记录同步了哪些数据，主节点只需要根据这个数据复制的偏移将没有同步的数据发送给从节点进行同步就可以了。

### 五、redis哨兵和集群

主从数据同步的问题解决了，那还有就是主节点挂了，应该怎么检测到并且选出新的从节点顶替作为主节点呢。

这个就需要专门的redis节点去进行一个监控的功能，也就是起到一个哨兵的作用，通过多个哨兵一般3个去监控各个节点的状态，如果发现某个节点挂了，就重新让新的从节点定义旧的主节点，旧的主节点则作为从节点。



但是随着redis存储的数据变多的时候，每个节点都存储全量数据，容易给系统造成性能瓶颈。

可以各个节点都存储一部分数据，通过一个槽标识每个节点都存储了哪些数据。从而达到找出应该在哪个节点中进行数据查找。（这里没有深入了解具体实现，具体的槽标识使用什么数据结构，怎么从不同节点获取数据，后面再看下）

同样的，各个存储可部分数据的节点也需要进行一个高可用处理，也就是每个存储数据的节点都做一个主从集群就行了。

