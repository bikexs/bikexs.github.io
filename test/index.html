<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  
</head>

<body>
  <script>
    const content = `
    <tw-storydata name="穿越异世界" startnode="12" creator="Twine" creator-version="2.7.1" format="Harlowe" format-version="3.3.7" ifid="56A77D0D-AA7A-42B9-BDC3-24F8FF349D4A" options="" tags="" zoom="1" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css"></style><script role="script" id="twine-user-script" type="text/twine-javascript"><\/script><tw-passagedata pid="1" name="60000" tags="" position="400,175" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
这是？啥地方？
[[继续-&gt;60001]]</tw-passagedata><tw-passagedata pid="2" name="60001" tags="" position="600,175" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10001&quot;,
&quot;role_name&quot;: &quot;系统&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
叮！恭喜宿主来到玄武大陆，身体原主人所在家族遭到仇家追杀，导致一家四口惨遭横祸。需要宿主找出原因并为原主讨回公道。
[[继续-&gt;60002]]</tw-passagedata><tw-passagedata pid="3" name="60002" tags="" position="600,300" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
啥玩意？关于我穿越到异世界为原主人报仇这件事！！
[[可是，我不想穿越啊，我该怎么回去。-&gt;60007]]
[[穿越了！！！这也太爽了吧-&gt;60005]]
[[这么荒唐，谁信啊，这一定是梦！-&gt;60003]]</tw-passagedata><tw-passagedata pid="4" name="60999" tags="" position="575,775" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10003&quot;,
&quot;role_name&quot;: &quot;旁白&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
异世界探索之旅开始。</tw-passagedata><tw-passagedata pid="5" name="60003" tags="" position="725,425" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10003&quot;,
&quot;role_name&quot;: &quot;旁白&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
你认为这是一场梦，你选择：
[[试图让自己清醒过来，用力给自己一巴掌。-&gt;60004]]
[[一头往桌角撞去，让自己醒过来。-&gt;60998]]</tw-passagedata><tw-passagedata pid="6" name="60004" tags="" position="725,550" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
啪！！这么痛，还很清醒，难道真的不是梦。
[[继续-&gt;60008]]</tw-passagedata><tw-passagedata pid="7" name="60998" tags="" position="850,550" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10003&quot;,
&quot;role_name&quot;: &quot;旁白&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
游戏结束。结局：游戏结束@意外身亡</tw-passagedata><tw-passagedata pid="8" name="60005" tags="" position="600,425" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10003&quot;,
&quot;role_name&quot;: &quot;旁白&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
无论何时何地，仍能保持一个乐观的心态。&lt;red&gt;专注+1&lt;red&gt;。
[[继续-&gt;60999]]</tw-passagedata><tw-passagedata pid="9" name="60007" tags="" position="475,425" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10003&quot;,
&quot;role_name&quot;: &quot;旁白&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
你的抱怨似乎没有得到任何回应。
[[继续-&gt;60999]]</tw-passagedata><tw-passagedata pid="10" name="60008" tags="" position="725,675" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
算了，还是先看看这地方吧。
[[继续-&gt;60999]]</tw-passagedata><tw-passagedata pid="11" name="61000" tags="" position="250,925" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
玄元大陆，叶落村。
[[继续-&gt;60000]]</tw-passagedata><tw-passagedata pid="12" name="99999" tags="" position="50,1025" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
玄元大陆。
[[叶落村-&gt;61000]]
[[不夜城-&gt;65000]]</tw-passagedata><tw-passagedata pid="13" name="65000" tags="" position="275,1075" size="100,100">&lt;!--
&lt;ext&gt;
{
&quot;role_id&quot;: &quot;10000&quot;,
&quot;role_name&quot;: &quot;叶枫&quot;,
&quot;position&quot;: &quot;LEFT_DOWN&quot;
}
&lt;/ext&gt;
--&gt;
玄元大陆，不夜城。</tw-passagedata></tw-storydata>
`
     const downloadStringAsFile = (data, filename, mimeType = 'text/plain') => {
       const blob = new Blob([data], { type: mimeType });
       const url = URL.createObjectURL(blob);
       const a = document.createElement('a');
       a.href = url;
       a.download = filename;
       // 将 a 元素附加到 DOM 中
       document.body.appendChild(a);
       // 模拟点击链接以触发下载
       a.click();
       // 从 DOM 中移除 a 元素
       document.body.removeChild(a);
       // 释放对象 URL
       URL.revokeObjectURL(url);
     }
     const parser = new DOMParser()
     const doc = parser.parseFromString(content, 'text/html')
     console.log(doc)
     const rootTag = 'tw-storydata'
     const rootEle = doc.getElementsByTagName(rootTag)[0]
 
     const regexReader = {
       ext: /<ext>([\s\S]*?)<\/ext>/g,
       squareBrackets: /\[\[(.*?)\]\]/g,
       comment: /<!--([\s\S]*?)-->/g,
     }
     const removeContent = (content, tags) => {
       let res = content
       tags?.forEach(item => {
         if (regexReader[item]) {
           res = res.replace(regexReader[item], '')
         }
       })
       return res
     }
     const readTagContent = (content, tagName) => {
       const res = []
       if (!content || !regexReader[tagName]) {
         return res
       }
       let matcher = null
       while ((matcher = regexReader[tagName].exec(content)) !== null) {
         res.push(matcher[1])
       }
       return res
     }
 
     const buildTree = (rootEle, startNodeId) => {
         const childs = rootEle.getElementsByTagName('tw-passagedata')
         const childNodes = []
         let counter = 0
         const handleChild = (child) => {
           const title = child?.getAttribute('name')
           const content = child?.textContent.trim().replace(/[\r\n]/g, '')
           const ext = readTagContent(content, 'ext')
           let nodeId = child.getAttribute('pid')  // twine，pid: passage id,对应每一个文本节点id
           let extObj = null
           if (ext[0]) {
             extObj = JSON.parse(ext[0])
           }
           const edges = readTagContent(content, 'squareBrackets')
           const text = removeContent(content, ['comment', 'squareBrackets'])
           let row = {
             id: title, 
             content: text,
             nodeId: nodeId,
             type: 'TEXT',
             effect: ''
           }
           if (extObj) {
             row = {...extObj, ...row}
           }
           // 处理边
           const actionNode = []
           edges?.forEach(edge => {
             const splitIdx = edge.indexOf('->')
             if (splitIdx == -1) {
               return
             }
             const actionName = edge.slice(0, splitIdx)
             const nextId = edge.slice(splitIdx + 2)
             if (actionName == '继续') {
               // 默认包含一个继续按钮action，不处理。分支线保证不会出现继续作为选项
               row.next = nextId
               return;
             }
             actionNode.push({
               id: 'action_' + ++counter,
               type: 'ACTION',
               effect: '',
               content: actionName,
               next: nextId
             })
           })
           if (actionNode.length > 0) {
             row.next = actionNode.map(item => item.id).join('@')
           }
           childNodes.push(row)
           childNodes.push(...actionNode)
         }
         // 读取节点
         for (let childIdx = 0; childIdx < childs.length; childIdx++) {
           handleChild(childs[childIdx])
         }
         console.log('childnodes:', childNodes)
         // arr to obj
         const childObj = childNodes.reduce((obj, curValue) => {
           obj[curValue.id] = curValue
           return obj
         }, {})
         // 构建节点树
         const buildNode = (nodeObj, curNode) => {
           if (!curNode) {
             return
           }
           const nextIds = curNode.next
           const nextIdList = nextIds?.split('@')
           curNode.children = nextIdList?.map(id => nodeObj[id])
           curNode.children?.forEach(item => buildNode(nodeObj, item))
         }
         const startNode = Object.values(childObj).filter(item => item.nodeId ==startNodeId)[0]
         buildNode(childObj, startNode)
         return startNode
       } 
     if (rootEle) {
       const tree = {
         rootNodeId: rootEle.getAttribute('startnode'),
         creatorVersion: rootEle.getAttribute('creator-version'),
         rootNode: buildTree(rootEle, rootEle.getAttribute('startnode'))
       }
       
       console.log('tree: ', tree)
 
       // 转换为CSV格式数据（每个节点对应一行
       const res = []
       const toCsvValue = (obj) => {
        if (!obj) {
          return ''
        }
        return obj
       }
       const treeToCsv = (root, res) => {
         if (!root) {
           return
         }
         res.push({
           id: toCsvValue(root.id),
           role_id: toCsvValue(root.role_id),
           role_name: toCsvValue(root.role_name),
           type: toCsvValue(root.type),
           position: toCsvValue(root.position),
           next: toCsvValue(root.next),
           content: toCsvValue(root.content),
           effect: toCsvValue(root.effect),
           condition_rules: toCsvValue(root.condition_rules),
           target: toCsvValue(root.target)
         })
         root?.children?.forEach(node => treeToCsv(node, res))
       }
       treeToCsv(tree.rootNode, res)
       console.log('csv data: ', res)
       // 保存到文件，提供下载
       const saveDataToCsv = (rows, headers, types, labels) => {
         const dataRows = rows?.map(row => {
           const tmpList = []
           headers?.forEach(key => {
             row[key] !== undefined && row[key] !== null && tmpList.push(row[key])
           })
           return tmpList.join(',')
         })
         const str = [headers.join(','), types.join(','), labels.join(','), ...dataRows].join('\n')
         downloadStringAsFile(str, 'data.csv')
       }
       const headers = ['id', 'type', 'role_id', 'role_name', 'position', 'content', 'next', 'effect', 'target', 'remark', 'condition_rule']
       const types = ['string', 'string', 'string', 'string', 'string', 'string', 'string', 'string', 'string', 'string', 'string']
       const labels = ['id', '类型', '角色id', '角色名', '对话框位置', '内容', '下一个', '效果', '目标', '备注', '该对话显示条件']
       saveDataToCsv(res, headers, types, labels)
     }
     
   </script>
</body>
</html>